# Домашнее задание: Базы данных, репликация и масштабирование

## Задание 1: Преимущества использования масштабирования методами репликации

### 1. Активный master-сервер и пассивный репликационный slave-сервер

Основные преимущества:
1. Повышение доступности системы - при отказе master-сервера можно быстро переключиться на slave-сервер
2. Разделение нагрузки - запросы на чтение можно направлять на slave-сервер, оставляя master для операций записи
3. Безопасное резервное копирование - создание бэкапов можно выполнять на slave-сервере без остановки основной БД
4. Упрощение процесса обслуживания - можно выполнять технические работы на slave, пока master продолжает работу
5. Географическое распределение - slave можно разместить в другом дата-центре для повышения надежности

### 2. Master-сервер и несколько slave-серверов

Основные преимущества:
1. Масштабируемость операций чтения - нагрузку на чтение можно распределить между несколькими slave-серверами
2. Повышенная отказоустойчивость - при выходе из строя одного slave остальные продолжают работу
3. Географическое распределение - slave-серверы можно размещать в разных регионах для уменьшения задержек
4. Специализация slave-серверов - разные slave можно использовать для разных задач (аналитика, отчетность, обслуживание трафика)
5. Улучшенная производительность при пиковых нагрузках - можно временно добавлять дополнительные slave-серверы
6. Гибкость в обслуживании - можно выводить slave-серверы на обслуживание поочередно

Сравнение подходов:
- Первая схема проще в реализации и обслуживании, подходит для небольших и средних проектов
- Вторая схема обеспечивает лучшую масштабируемость и отказоустойчивость, но сложнее в настройке и дороже

## Задание 2: План горизонтального и вертикального шардинга БД

## Горизонтальный шардинг (3 шарда)

### Правила распределения данных:

| Таблица | Правило распределения | Шард 1 | Шард 2 | Шард 3 |
|---------|----------------------|--------|--------|--------|
| Пользователи | id % 3 | id % 3 = 0 | id % 3 = 1 | id % 3 = 2 |
| Книги | Первая буква названия | А-И | К-Т | У-Я |
| Магазины | Регион | Москва и МО | СПб и ЛО | Другие регионы |

### Вертикальный шардинг - разделение данных

| Таблица | Публичные данные (Основной шард) | Приватные данные (Вертикальный шард) |
|---------|----------------------------------|--------------------------------------|
| **Пользователи** | id, email, имя, город, страна | пароль, телефон, история_покупок |
| **Книги** | id, название, автор, жанр, цена | описание, отзывы, рейтинг |
| **Магазины** | id, название, адрес, регион, менеджер_id | выручка, количество_продаж, расходы |

Принципы системы шардинга
Разграничение между базами
Горизонтальный шардинг:
3 независимые базы на разных серверах

Идентичная структура, разные строки данных

Каждая запись только в одном шарде

Нет прямых связей между шардами

Вертикальный шардинг:
Внутри каждого горизонтального шарда

Публичные и приватные данные разделены

Связаны по id между таблицами

Приватные данные изолированы

Режимы работы серверов
Шард-контроллер:
Активный режим

Маршрутизация запросов по правилам

Балансировка нагрузки

Master-сервер (в каждом шарде):
Активный режим записи

Хранит публичные данные

Реплицирует на подчинённые

Replica-серверы (в каждом шарде):
Пассивный режим чтения

2 реплики на шард

Принимают запросы SELECT

Вертикальные шарды:
Активный с ограниченным доступом

Хранят приватные данные

Доступ только от своего Master

Ключевой принцип
text
Горизонтально: данные РАЗНЫХ пользователей на РАЗНЫХ серверах
Вертикально: РАЗНЫЕ типы данных одного пользователя на РАЗНЫХ серверах
Архитектура системы
text
[Клиентское приложение]
        ↓
[Балансировщик нагрузки (HAProxy)]
        ↓
[Шард-контроллер]
        |
        ├── Шард 1 → Master + 2 Replica + Vertical Shard
        ├── Шард 2 → Master + 2 Replica + Vertical Shard
        └── Шард 3 → Master + 2 Replica + Vertical Shard
Технологии для реализации
Базы данных: PostgreSQL

Шардинг: Citus extension или кастомное решение

Балансировщик: HAProxy

Кэш: Redis (для шард-контроллера)

Репликация: Встроенные механизмы PostgreSQL

Примечание: Вертикальный шардинг применяется внутри каждого горизонтального шарда. Каждый из 3 горизонтальных шардов имеет свою вертикальную секцию для хранения приватных данных.



